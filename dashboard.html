<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>암호화폐 대시보드 - 전체 분석</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }

        .card-title {
            font-size: 1.2em;
            color: #667eea;
            margin-bottom: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .price-display {
            display: flex;
            align-items: baseline;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .current-price {
            font-size: 2.5em;
            font-weight: bold;
            color: #2c3e50;
        }

        .big-number {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
            margin: 10px 0;
        }

        .price-change {
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .price-up {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .price-down {
            background: #ffebee;
            color: #c62828;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #ecf0f1;
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .stat-value {
            font-weight: 600;
            color: #2c3e50;
            text-align: right;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.2em;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .last-update {
            text-align: center;
            color: white;
            font-size: 0.9em;
            margin-top: 20px;
            opacity: 0.8;
        }

        .filter-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 15px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-label {
            font-size: 0.9em;
            color: #667eea;
            font-weight: 600;
        }

        .filter-input {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .filter-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .filter-button {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .filter-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .filter-button:active {
            transform: translateY(0);
        }

        .date-range-display {
            text-align: center;
            color: #7f8c8d;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
            max-height: 400px;
            overflow-y: auto;
            display: block;
        }

        .data-table thead {
            position: sticky;
            top: 0;
            background: #667eea;
            color: white;
            z-index: 10;
        }

        .data-table th {
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
        }

        .data-table tbody {
            display: block;
            max-height: 350px;
            overflow-y: auto;
        }

        .data-table tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }

        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #ecf0f1;
        }

        .data-table tbody tr:hover {
            background: #f8f9fa;
        }

        .highlight-positive {
            color: #2e7d32;
            font-weight: 600;
        }

        .highlight-negative {
            color: #c62828;
            font-weight: 600;
        }

        .section-title {
            color: white;
            font-size: 1.8em;
            margin: 40px 0 20px 0;
            font-weight: 600;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .icon {
            font-size: 1.2em;
        }

        @media (max-width: 1024px) {
            .dashboard-grid-2 {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .current-price {
                font-size: 2em;
            }

            .filter-grid {
                grid-template-columns: 1fr;
            }

            .data-table {
                font-size: 0.8em;
            }

            .filter-container > div:first-of-type {
                grid-template-columns: 1fr !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>🚀 암호화폐 완전 분석 대시보드</h1>
            <p class="subtitle">비트코인(BTC) 모든 데이터 및 기술적 분석</p>
        </header>

        <div id="loading" class="loading">
            데이터를 불러오는 중...
        </div>

        <div id="error" style="display:none;" class="error"></div>

        <div id="dashboard" style="display:none;">
            <!-- 암호화폐 선택 및 날짜 필터 -->
            <div class="filter-container">
                <div class="card-title">🪙 암호화폐 선택 & 기간 설정</div>
                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 15px; align-items: end; margin-bottom: 15px;">
                    <div class="filter-group">
                        <label class="filter-label">암호화폐</label>
                        <select id="coinSelect" class="filter-input" onchange="onCoinChange()">
                            <option value="">암호화폐를 선택하세요...</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">데이터 개수</label>
                        <select id="dataCount" class="filter-input">
                            <option value="30">30일</option>
                            <option value="60">60일</option>
                            <option value="100" selected>100일</option>
                            <option value="200">200일</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">기준일</label>
                        <input type="date" id="baseDate" class="filter-input">
                    </div>
                    <button class="filter-button" onclick="loadCoinData()">데이터 로드</button>
                </div>
                <div class="filter-grid">
                    <div class="filter-group">
                        <label class="filter-label">시작일</label>
                        <input type="date" id="startDate" class="filter-input">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">종료일</label>
                        <input type="date" id="endDate" class="filter-input">
                    </div>
                    <button class="filter-button" onclick="applyDateFilter()">필터 적용</button>
                </div>
                <div class="date-range-display" id="dateRangeDisplay"></div>
            </div>

            <h2 class="section-title">💰 주요 가격 정보</h2>

            <!-- 주요 지표 카드 -->
            <div class="dashboard-grid">
                <div class="card">
                    <div class="card-title"><span class="icon">💵</span> 현재 가격</div>
                    <div class="price-display">
                        <span class="current-price" id="currentPrice">-</span>
                        <span class="price-change" id="priceChange">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">전일 종가</span>
                        <span class="stat-value" id="prevClose">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">가격 변동액</span>
                        <span class="stat-value" id="changePrice">-</span>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title"><span class="icon">📊</span> 일일 변동</div>
                    <div class="stat-row">
                        <span class="stat-label">시가</span>
                        <span class="stat-value" id="openPrice">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">최고가</span>
                        <span class="stat-value" id="highPrice">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">최저가</span>
                        <span class="stat-value" id="lowPrice">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">변동폭</span>
                        <span class="stat-value" id="priceRange">-</span>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title"><span class="icon">💎</span> 거래량</div>
                    <div class="stat-row">
                        <span class="stat-label">거래량 (BTC)</span>
                        <span class="stat-value" id="tradeVolume">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">거래대금</span>
                        <span class="stat-value" id="tradePrice">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">평균 거래가</span>
                        <span class="stat-value" id="avgPrice">-</span>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title"><span class="icon">📈</span> 기간 통계</div>
                    <div class="stat-row">
                        <span class="stat-label">기간 최고가</span>
                        <span class="stat-value" id="periodHighPrice">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">기간 최저가</span>
                        <span class="stat-value" id="periodLowPrice">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">평균가</span>
                        <span class="stat-value" id="periodAvgPrice">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">총 거래량</span>
                        <span class="stat-value" id="totalVolume">-</span>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title"><span class="icon">📉</span> 변동성 분석</div>
                    <div class="stat-row">
                        <span class="stat-label">평균 변동률</span>
                        <span class="stat-value" id="avgChangeRate">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">최대 변동률</span>
                        <span class="stat-value" id="maxChangeRate">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">평균 일일 변동폭</span>
                        <span class="stat-value" id="avgDailyRange">-</span>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title"><span class="icon">🎯</span> 추세 분석</div>
                    <div class="stat-row">
                        <span class="stat-label">상승일</span>
                        <span class="stat-value" id="upDays">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">하락일</span>
                        <span class="stat-value" id="downDays">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">승률</span>
                        <span class="stat-value" id="winRate">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">기간 누적 수익률</span>
                        <span class="stat-value" id="totalReturn">-</span>
                    </div>
                </div>
            </div>

            <h2 class="section-title">📊 차트 분석</h2>

            <!-- 일봉 캔들스틱 차트 -->
            <div class="chart-container">
                <div class="card-title">📊 일봉 캔들차트 (OHLC)</div>
                <div class="chart-wrapper">
                    <canvas id="candlestickChart"></canvas>
                </div>
            </div>

            <!-- 2열 차트 그리드 -->
            <div class="dashboard-grid-2">
                <!-- 가격 차트 with 이동평균선 -->
                <div class="chart-container">
                    <div class="card-title">📈 가격 추이 & 이동평균선</div>
                    <div class="chart-wrapper">
                        <canvas id="priceChart"></canvas>
                    </div>
                </div>

                <!-- 거래량 차트 -->
                <div class="chart-container">
                    <div class="card-title">💹 거래량 추이</div>
                    <div class="chart-wrapper">
                        <canvas id="volumeChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- 추가 분석 차트 -->
            <div class="dashboard-grid-2">
                <!-- 일일 변동률 차트 -->
                <div class="chart-container">
                    <div class="card-title">📉 일일 변동률</div>
                    <div class="chart-wrapper">
                        <canvas id="changeRateChart"></canvas>
                    </div>
                </div>

                <!-- 일일 변동폭 차트 -->
                <div class="chart-container">
                    <div class="card-title">📏 일일 가격 변동폭</div>
                    <div class="chart-wrapper">
                        <canvas id="rangeChart"></canvas>
                    </div>
                </div>
            </div>

            <h2 class="section-title">📋 상세 데이터 테이블</h2>

            <!-- 데이터 테이블 -->
            <div class="card">
                <div class="card-title">📑 전체 데이터</div>
                <table class="data-table" id="dataTable">
                    <thead>
                        <tr>
                            <th>날짜</th>
                            <th>시가</th>
                            <th>고가</th>
                            <th>저가</th>
                            <th>종가</th>
                            <th>변동률</th>
                            <th>거래량</th>
                            <th>거래대금</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody">
                    </tbody>
                </table>
            </div>

            <div class="last-update">
                마지막 업데이트: <span id="lastUpdate">-</span> | 데이터 제공: Upbit API
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        let allData = [];
        let filteredData = [];
        let priceChartInstance = null;
        let volumeChartInstance = null;
        let candlestickChartInstance = null;
        let changeRateChartInstance = null;
        let rangeChartInstance = null;
        let availableMarkets = [];
        let currentMarket = 'KRW-BTC';
        let currentCoinName = '비트코인';

        // 숫자 포맷팅 함수
        function formatNumber(num) {
            return new Intl.NumberFormat('ko-KR').format(Math.round(num));
        }

        function formatDecimal(num, decimals = 2) {
            return new Intl.NumberFormat('ko-KR', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            }).format(num);
        }

        function formatLargeNumber(num) {
            if (num >= 1000000000000) {
                return formatDecimal(num / 1000000000000, 2) + '조';
            } else if (num >= 100000000) {
                return formatDecimal(num / 100000000, 2) + '억';
            } else if (num >= 10000) {
                return formatDecimal(num / 10000, 2) + '만';
            }
            return formatNumber(num);
        }

        // 날짜 포맷팅 함수
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        function formatDateForInput(dateString) {
            const date = new Date(dateString);
            return date.toISOString().split('T')[0];
        }

        // 마켓 목록 로드
        async function loadMarkets() {
            try {
                const response = await fetch('https://api.upbit.com/v1/market/all?isDetails=true');
                if (!response.ok) {
                    throw new Error('마켓 정보를 불러올 수 없습니다.');
                }
                
                const markets = await response.json();
                // KRW 마켓만 필터링
                availableMarkets = markets.filter(m => m.market.startsWith('KRW-'));
                
                // 셀렉트 박스에 옵션 추가
                const select = document.getElementById('coinSelect');
                select.innerHTML = '<option value="">암호화폐를 선택하세요...</option>';
                
                availableMarkets.forEach(market => {
                    const option = document.createElement('option');
                    option.value = market.market;
                    option.textContent = `${market.korean_name} (${market.market})`;
                    select.appendChild(option);
                });
                
                // 기본값으로 BTC 선택
                select.value = 'KRW-BTC';
                
            } catch (error) {
                console.error('Error loading markets:', error);
                alert('암호화폐 목록을 불러오는데 실패했습니다: ' + error.message);
            }
        }

        // 암호화폐 변경 이벤트
        function onCoinChange() {
            const select = document.getElementById('coinSelect');
            currentMarket = select.value;
            
            if (currentMarket) {
                const selected = availableMarkets.find(m => m.market === currentMarket);
                currentCoinName = selected ? selected.korean_name : currentMarket;
            }
        }

        // 코인 데이터 로드
        async function loadCoinData() {
            const market = document.getElementById('coinSelect').value;
            const count = document.getElementById('dataCount').value;
            const baseDate = document.getElementById('baseDate').value;
            
            if (!market) {
                alert('암호화폐를 선택해주세요.');
                return;
            }
            
            if (!baseDate) {
                alert('기준일을 선택해주세요.');
                return;
            }
            
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('dashboard').style.display = 'none';
                
                // Upbit API 호출
                const url = `https://api.upbit.com/v1/candles/days?market=${market}&count=${count}&to=${baseDate} 00:00:00`;
                const response = await fetch(url, {
                    headers: { "accept": "application/json" }
                });
                
                if (!response.ok) {
                    throw new Error('데이터를 불러올 수 없습니다.');
                }
                
                allData = await response.json();
                filteredData = [...allData];
                
                if (allData.length === 0) {
                    throw new Error('데이터가 없습니다.');
                }
                
                // 날짜 입력 필드 초기화
                const oldestDate = allData[allData.length - 1].candle_date_time_kst;
                const newestDate = allData[0].candle_date_time_kst;
                document.getElementById('startDate').value = formatDateForInput(oldestDate);
                document.getElementById('endDate').value = formatDateForInput(newestDate);
                
                // 헤더 업데이트
                document.querySelector('header .subtitle').textContent = `${currentCoinName} 모든 데이터 및 기술적 분석`;
                
                // 데이터 업데이트
                updateDashboard();
                
                // UI 표시
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = '데이터를 불러오는 중 오류가 발생했습니다: ' + error.message;
            }
        }

        // 데이터 로드 및 대시보드 초기화
        async function initDashboard() {
            try {
                // 오늘 날짜 설정
                const today = new Date();
                document.getElementById('baseDate').value = formatDateForInput(today);
                
                // 마켓 목록 로드
                await loadMarkets();
                
                // 로컬 JSON 파일이 있으면 로드 시도
                try {
                    const response = await fetch('KRW-BTC_2025-03-24_00-00-00_100.json');
                    if (response.ok) {
                        allData = await response.json();
                        filteredData = [...allData];
                        
                        // 날짜 입력 필드 초기화
                        const oldestDate = allData[allData.length - 1].candle_date_time_kst;
                        const newestDate = allData[0].candle_date_time_kst;
                        document.getElementById('startDate').value = formatDateForInput(oldestDate);
                        document.getElementById('endDate').value = formatDateForInput(newestDate);
                        
                        // 데이터 업데이트
                        updateDashboard();
                    }
                } catch (e) {
                    // 로컬 파일이 없으면 무시
                    console.log('로컬 파일을 찾을 수 없습니다. API에서 데이터를 로드하세요.');
                }
                
                // UI 표시
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = '초기화 중 오류가 발생했습니다: ' + error.message;
            }
        }

        // 날짜 필터 적용
        function applyDateFilter() {
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            
            if (isNaN(startDate) || isNaN(endDate)) {
                alert('올바른 날짜를 선택해주세요.');
                return;
            }
            
            if (startDate > endDate) {
                alert('시작일은 종료일보다 앞서야 합니다.');
                return;
            }
            
            // 날짜 필터링
            filteredData = allData.filter(item => {
                const itemDate = new Date(item.candle_date_time_kst);
                return itemDate >= startDate && itemDate <= endDate;
            });
            
            if (filteredData.length === 0) {
                alert('선택한 기간에 데이터가 없습니다.');
                return;
            }
            
            // 대시보드 업데이트
            updateDashboard();
            
            // 날짜 범위 표시
            document.getElementById('dateRangeDisplay').textContent = 
                `표시 기간: ${formatDate(filteredData[filteredData.length - 1].candle_date_time_kst)} ~ ${formatDate(filteredData[0].candle_date_time_kst)} (${filteredData.length}일)`;
        }

        // 대시보드 업데이트
        function updateDashboard() {
            if (!filteredData || filteredData.length === 0) {
                console.warn('표시할 데이터가 없습니다.');
                return;
            }
            
            // 데이터가 최신순이므로 첫 번째가 최신 데이터
            const latestData = filteredData[0];
            const oldestData = filteredData[filteredData.length - 1];
            
            // 주요 지표 업데이트
            updateMainStats(latestData);
            
            // 기간 통계 업데이트
            updatePeriodStats(filteredData);
            
            // 차트 생성 (데이터를 오래된 순으로 정렬)
            const reversedData = [...filteredData].reverse();
            createCandlestickChart(reversedData);
            createPriceChart(reversedData);
            createVolumeChart(reversedData);
            createChangeRateChart(reversedData);
            createRangeChart(reversedData);
            
            // 데이터 테이블 업데이트
            updateDataTable(filteredData);
        }

        // 주요 통계 업데이트
        function updateMainStats(data) {
            const changeRate = data.change_rate * 100;
            const isPositive = changeRate >= 0;
            
            document.getElementById('currentPrice').textContent = formatNumber(data.trade_price) + ' 원';
            
            const priceChangeEl = document.getElementById('priceChange');
            priceChangeEl.textContent = (isPositive ? '+' : '') + formatDecimal(changeRate, 2) + '%';
            priceChangeEl.className = 'price-change ' + (isPositive ? 'price-up' : 'price-down');
            
            document.getElementById('prevClose').textContent = formatNumber(data.prev_closing_price) + ' 원';
            
            const changePriceEl = document.getElementById('changePrice');
            changePriceEl.innerHTML = `<span class="${isPositive ? 'highlight-positive' : 'highlight-negative'}">${isPositive ? '+' : ''}${formatNumber(data.change_price)} 원</span>`;
            
            document.getElementById('tradePrice').textContent = formatLargeNumber(data.candle_acc_trade_price) + ' 원';
            document.getElementById('tradeVolume').textContent = formatDecimal(data.candle_acc_trade_volume, 4) + ' BTC';
            document.getElementById('avgPrice').textContent = formatNumber(data.candle_acc_trade_price / data.candle_acc_trade_volume) + ' 원';
            
            document.getElementById('highPrice').textContent = formatNumber(data.high_price) + ' 원';
            document.getElementById('lowPrice').textContent = formatNumber(data.low_price) + ' 원';
            document.getElementById('openPrice').textContent = formatNumber(data.opening_price) + ' 원';
            
            const priceRange = data.high_price - data.low_price;
            document.getElementById('priceRange').textContent = formatNumber(priceRange) + ' 원 (' + formatDecimal((priceRange / data.low_price) * 100, 2) + '%)';
            
            document.getElementById('lastUpdate').textContent = formatDate(data.candle_date_time_kst);
        }

        // 기간 통계 업데이트
        function updatePeriodStats(data) {
            const prices = data.map(d => d.trade_price);
            const highPrices = data.map(d => d.high_price);
            const lowPrices = data.map(d => d.low_price);
            const changeRates = data.map(d => d.change_rate * 100);
            const volumes = data.map(d => d.candle_acc_trade_volume);
            
            const periodHigh = Math.max(...highPrices);
            const periodLow = Math.min(...lowPrices);
            const avgPrice = prices.reduce((a, b) => a + b, 0) / prices.length;
            const totalVolume = volumes.reduce((a, b) => a + b, 0);
            
            document.getElementById('periodHighPrice').textContent = formatNumber(periodHigh) + ' 원';
            document.getElementById('periodLowPrice').textContent = formatNumber(periodLow) + ' 원';
            document.getElementById('periodAvgPrice').textContent = formatNumber(avgPrice) + ' 원';
            document.getElementById('totalVolume').textContent = formatDecimal(totalVolume, 2) + ' BTC';
            
            // 변동성 분석
            const avgChangeRate = changeRates.reduce((a, b) => a + Math.abs(b), 0) / changeRates.length;
            const maxChangeRate = Math.max(...changeRates.map(Math.abs));
            const dailyRanges = data.map(d => d.high_price - d.low_price);
            const avgDailyRange = dailyRanges.reduce((a, b) => a + b, 0) / dailyRanges.length;
            
            document.getElementById('avgChangeRate').textContent = formatDecimal(avgChangeRate, 2) + '%';
            document.getElementById('maxChangeRate').textContent = formatDecimal(maxChangeRate, 2) + '%';
            document.getElementById('avgDailyRange').textContent = formatNumber(avgDailyRange) + ' 원';
            
            // 추세 분석
            const upDays = changeRates.filter(r => r > 0).length;
            const downDays = changeRates.filter(r => r < 0).length;
            const winRate = (upDays / (upDays + downDays)) * 100;
            
            const oldestPrice = data[data.length - 1].trade_price;
            const newestPrice = data[0].trade_price;
            const totalReturn = ((newestPrice - oldestPrice) / oldestPrice) * 100;
            
            document.getElementById('upDays').innerHTML = `<span class="highlight-positive">${upDays}일</span>`;
            document.getElementById('downDays').innerHTML = `<span class="highlight-negative">${downDays}일</span>`;
            document.getElementById('winRate').textContent = formatDecimal(winRate, 1) + '%';
            
            const totalReturnEl = document.getElementById('totalReturn');
            totalReturnEl.innerHTML = `<span class="${totalReturn >= 0 ? 'highlight-positive' : 'highlight-negative'}">${totalReturn >= 0 ? '+' : ''}${formatDecimal(totalReturn, 2)}%</span>`;
        }

        // 캔들스틱 차트 생성
        function createCandlestickChart(data) {
            const ctx = document.getElementById('candlestickChart').getContext('2d');
            
            if (candlestickChartInstance) {
                candlestickChartInstance.destroy();
            }
            
            const candlestickData = data.map(d => ({
                x: new Date(d.candle_date_time_kst).getTime(),
                o: d.opening_price,
                h: d.high_price,
                l: d.low_price,
                c: d.trade_price
            }));
            
            candlestickChartInstance = new Chart(ctx, {
                type: 'candlestick',
                data: {
                    datasets: [{
                        label: currentMarket || 'BTC/KRW',
                        data: candlestickData,
                        color: {
                            up: '#2e7d32',
                            down: '#c62828',
                            unchanged: '#999'
                        },
                        borderColor: {
                            up: '#2e7d32',
                            down: '#c62828',
                            unchanged: '#999'
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const point = context.raw;
                                    return [
                                        '시가: ' + formatNumber(point.o) + ' 원',
                                        '고가: ' + formatNumber(point.h) + ' 원',
                                        '저가: ' + formatNumber(point.l) + ' 원',
                                        '종가: ' + formatNumber(point.c) + ' 원'
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                displayFormats: {
                                    day: 'MM/dd'
                                }
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return formatNumber(value) + ' 원';
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    }
                }
            });
        }

        // 이동평균선 계산
        function calculateMA(data, period) {
            const result = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    result.push(null);
                } else {
                    const sum = data.slice(i - period + 1, i + 1).reduce((a, b) => a + b.trade_price, 0);
                    result.push(sum / period);
                }
            }
            return result;
        }

        // 가격 차트 생성 (이동평균선 포함)
        function createPriceChart(data) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            if (priceChartInstance) {
                priceChartInstance.destroy();
            }
            
            const ma5 = calculateMA(data, 5);
            const ma20 = calculateMA(data, 20);
            
            priceChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => formatDate(d.candle_date_time_kst)),
                    datasets: [{
                        label: '종가',
                        data: data.map(d => d.trade_price),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0,
                        pointHoverRadius: 6,
                        borderWidth: 2
                    }, {
                        label: '5일 이동평균',
                        data: ma5,
                        borderColor: '#ff6b6b',
                        backgroundColor: 'transparent',
                        tension: 0.4,
                        pointRadius: 0,
                        borderWidth: 1.5,
                        borderDash: [5, 5]
                    }, {
                        label: '20일 이동평균',
                        data: ma20,
                        borderColor: '#4ecdc4',
                        backgroundColor: 'transparent',
                        tension: 0.4,
                        pointRadius: 0,
                        borderWidth: 1.5,
                        borderDash: [5, 5]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatNumber(context.parsed.y) + ' 원';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return formatNumber(value);
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                maxTicksLimit: 10
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // 거래량 차트 생성
        function createVolumeChart(data) {
            const ctx = document.getElementById('volumeChart').getContext('2d');
            
            if (volumeChartInstance) {
                volumeChartInstance.destroy();
            }
            
            volumeChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => formatDate(d.candle_date_time_kst)),
                    datasets: [{
                        label: '거래량',
                        data: data.map(d => d.candle_acc_trade_volume),
                        backgroundColor: data.map(d => 
                            d.change_rate >= 0 ? 'rgba(46, 125, 50, 0.6)' : 'rgba(198, 40, 40, 0.6)'
                        ),
                        borderColor: data.map(d => 
                            d.change_rate >= 0 ? 'rgba(46, 125, 50, 1)' : 'rgba(198, 40, 40, 1)'
                        ),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '거래량: ' + formatDecimal(context.parsed.y, 2) + ' BTC';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return formatDecimal(value, 0);
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                maxTicksLimit: 10
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // 변동률 차트 생성
        function createChangeRateChart(data) {
            const ctx = document.getElementById('changeRateChart').getContext('2d');
            
            if (changeRateChartInstance) {
                changeRateChartInstance.destroy();
            }
            
            changeRateChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => formatDate(d.candle_date_time_kst)),
                    datasets: [{
                        label: '변동률',
                        data: data.map(d => d.change_rate * 100),
                        backgroundColor: data.map(d => 
                            d.change_rate >= 0 ? 'rgba(46, 125, 50, 0.6)' : 'rgba(198, 40, 40, 0.6)'
                        ),
                        borderColor: data.map(d => 
                            d.change_rate >= 0 ? 'rgba(46, 125, 50, 1)' : 'rgba(198, 40, 40, 1)'
                        ),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '변동률: ' + formatDecimal(context.parsed.y, 2) + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return formatDecimal(value, 1) + '%';
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                maxTicksLimit: 10
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // 변동폭 차트 생성
        function createRangeChart(data) {
            const ctx = document.getElementById('rangeChart').getContext('2d');
            
            if (rangeChartInstance) {
                rangeChartInstance.destroy();
            }
            
            rangeChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => formatDate(d.candle_date_time_kst)),
                    datasets: [{
                        label: '변동폭',
                        data: data.map(d => d.high_price - d.low_price),
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '변동폭: ' + formatNumber(context.parsed.y) + ' 원';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return formatNumber(value);
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                maxTicksLimit: 10
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // 데이터 테이블 업데이트
        function updateDataTable(data) {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            
            data.forEach(item => {
                const row = document.createElement('tr');
                const changeRate = item.change_rate * 100;
                const changeClass = changeRate >= 0 ? 'highlight-positive' : 'highlight-negative';
                
                row.innerHTML = `
                    <td>${formatDate(item.candle_date_time_kst)}</td>
                    <td>${formatNumber(item.opening_price)}</td>
                    <td>${formatNumber(item.high_price)}</td>
                    <td>${formatNumber(item.low_price)}</td>
                    <td>${formatNumber(item.trade_price)}</td>
                    <td class="${changeClass}">${changeRate >= 0 ? '+' : ''}${formatDecimal(changeRate, 2)}%</td>
                    <td>${formatDecimal(item.candle_acc_trade_volume, 2)}</td>
                    <td>${formatLargeNumber(item.candle_acc_trade_price)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // 페이지 로드 시 대시보드 초기화
        window.addEventListener('load', initDashboard);
    </script>
</body>
</html>
